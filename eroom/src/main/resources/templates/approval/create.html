<!DOCTYPE html>
<html lang="en-US" dir="ltr" data-navigation-type="default" data-navbar-horizontal-shape="default" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{include/layout}">
<head>
<style>
.custom-table td, .custom-table th {
	padding: 0.5rem !important;
	min-width: 75px;
}
.treeview-label-strong {
  font-weight: bold;
  text-decoration: underline;
  color: #007bff;
}
.treeview-row {
  pointer-events: none;
}
.treeview-text a {
  text-decoration: none !important;
    display: block;
    width: 100%;
    height: 100%;
    padding: 5px 10px;
}

.treeview-text summary::marker,
.treeview-text a::before,
.treeview-text a::after {
  display: none !important;
  content: none !important;
}
      .treeview-text {
    cursor: pointer; /* 마우스 커서를 클릭 가능 모양으로 변경 */
  }
  
  .treeview-text:hover {
    background-color: #f0f4ff; /* 호버 시 살짝 색상 변화 */
  }
</style>
<meta charset="UTF-8">
<title>결재서 작성</title>
</head>
<body>
	<main class="main" id="top" layout:fragment="content">
		<div class="container bg-white rounded shadow-sm p-4 mt-4" style="max-width: 1000px;">
			<!-- <h2 class="mb-2 mx-auto">결재서 양식을 선택해주세요.</h2> -->
			<div class="d-flex justify-content-start mb-2">
				<span th:if="${mode == 'create'}" class="fw-bold fs-7" id="approvalPageTitle">결재서 양식을 선택해주세요.</span>
				<span th:if="${mode == 'edit'}" th:text="|${approval.approval_format.approvalFormatTitle} 결재서 작성|" class="fw-bold fs-7" id="approvalPageTitle">결재서 양식을 선택해주세요.</span>
			</div>
		<div class="card shadow-sm p-3 rounded-2xl mb-4">
			<!-- 결재 form -->
			<form id="approvalWriter">
				<div class="row">
					<div class="col-5">
						<div class="mb-1">
							<label class="form-label" for="basic-form-date">신청일</label>
							<div id="basic-form-date" class="form-control" th:text="${now}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-department_name">부서</label>
							<div id="basic-form-department_name" class="form-control" th:text="${departmentName}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-team_name">팀명</label>
							<div id="basic-form-team_name" class="form-control" th:text="${teamName}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-employee_position">직급</label>
							<div id="basic-form-employee_position" class="form-control" th:text="${employee.employeePosition}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-employee_name">신청자</label>
							<div id="basic-form-employee_name" class="form-control" th:text="${employee.employeeName}"></div>
						</div>
					</div>
					<div class="col-7">
						
						<label for="temp">　</label>
						<div id="temp" class="gap-2 mb-3 ms-right-2 d-flex justify-content-end flex-column align-items-end">
							<!-- <span style="vertical-align: middle;">결재자 :</span> -->
							<div class="mb-0" style="max-width: 73.337674%;">
								<div class="fw-bold text-dark border-bottom pb-1 mb-2">결재 라인</div>
								<div id="approvelLineTemp1" 
								     class="text-center text-secondary small border py-3 rounded"
								     th:attr="style=${mode == 'edit' and approvalLineList.?[approval_line_step >= 1].size() > 0 ? 'display: none;' : 'display: block;'}">
								    선택된 결재자가 없습니다.
								</div>
								<div class="text-end text-body-secondary fs-8 mt-1 d-flex gap-2" style="display: flex; overflow-x: auto; gap: 5px; max-width: 100%; white-space: nowrap;" id="approveLine1">
									<!-- 결재자 불러오기 -->
									<span th:each="approveMember, stat : ${approvalLineList}" th:if="${approveMember.approval_line_step >= 1}" class="badge border text-dark d-flex justify-content-end align-items-center" style="background-color: rgb(248, 249, 250);">
										<span th:text="${approveMember.employee.employeeName}"></span>
										<button type="button" class="btn-close" aria-label="Remove" data-prefix="approver" style="scale: 0.8;"></button>
										<input type="hidden" name="approverIds" th:value="${approveMember.employee.employeeNo}">
										<input type="hidden" name="approverSteps" th:value="${approveMember.approval_line_step}">
									</span>
									<!-- <span class="badge border text-dark d-flex justify-content-end align-items-center" style="background-color: rgb(248, 249, 250);">
										<span>오진석</span>
										<button type="button" class="btn-close" aria-label="Remove" data-prefix="approver" style="scale: 0.8;"></button>
										<input type="hidden" name="approverIds" value="4">
										<input type="hidden" name="approverSteps" value="1">
									</span> -->
								</div>
							</div>
							<!-- <span style="vertical-align: middle;">합의자 :</span> -->
							<div class="mb-0" style="max-width: 73.337674%;">
								<div class="fw-bold text-dark border-bottom pb-1 mb-2">합의 라인</div>
								<div id="approvelLineTemp2" 
								     class="text-center text-secondary small border py-3 rounded"
								     th:attr="style=${mode == 'edit' and approvalLineList.?[approval_line_step == 0].size() > 0 ? 'display: none;' : 'display: block;'}">
								    선택된 합의자가 없습니다.
								</div>
								<div class="text-end text-body-secondary fs-8 mt-1 d-flex gap-2" style="display: flex; overflow-x: auto; gap: 5px; max-width: 100%; white-space: nowrap;" id="approveLine2">
									<!-- 합의자 불러오기 --><!-- 
									<div th:each="approveMember, stat : ${approvalLineList}" th:if="${approveMember.approval_line_step == 0}" class="position-relative d-inline">
										<span class="badge border text-dark d-flex justify-content-end align-items-center"
										      style="background-color: rgb(248, 249, 250);">
										    <span th:text="${approveMember.employee.employeeName}"></span>
										    <button type="button" class="btn-close" th:attr="data-idx=${stat.count}"
										            aria-label="Remove" style="scale: 0.8;" data-prefix="agreer">
										    </button>
										    <input type="hidden" name="agreerIds" th:value="${approveMember.employee.employeeNo}">
										    <input type="hidden" name="agreerSteps" th:value="0">
										</span>
									</div>	 -->	
									<span th:each="approveMember, stat : ${approvalLineList}" th:if="${approveMember.approval_line_step == 0}" class="badge border text-dark d-flex justify-content-end align-items-center" style="background-color: rgb(248, 249, 250);">
										<span th:text="${approveMember.employee.employeeName}"></span>
										<button type="button" class="btn-close" aria-label="Remove" data-prefix="agreer" style="scale: 0.8;"></button>
										<input type="hidden" name="approverIds" th:value="${approveMember.employee.employeeNo}">
										<input type="hidden" name="approverSteps" th:value="0">
									</span>					
								</div>
							</div>
							<!-- <span style="vertical-align: middle;">참조자 :</span> -->
							<div class="mb-0" style="max-width: 73.337674%;">
								<div class="fw-bold text-dark border-bottom pb-1 mb-2">참조 라인</div>
								<div id="approvelLineTemp3" 
								     class="text-center text-secondary small border py-3 rounded"
								     th:attr="style=${mode == 'edit' and approvalLineList.?[approval_line_step == -1].size() > 0 ? 'display: none;' : 'display: block;'}">
								    선택된 참조자가 없습니다.
								</div>
								<div class="text-end text-body-secondary fs-8 mt-1 d-flex gap-2" style="display: flex; overflow-x: auto; gap: 5px; max-width: 100%; white-space: nowrap;" id="approveLine3">
									<!-- 합의자 불러오기 -->
									<!-- <div th:each="approveMember, stat : ${approvalLineList}" th:if="${approveMember.approval_line_step == -1}" class="position-relative d-inline">
										<span class="badge border text-dark d-flex justify-content-end align-items-center" style="background-color: rgb(248, 249, 250);">
											<span th:text="${approveMember.employee.employeeName}"></span>
											<button type="button" class="btn-close" th:attr="data-idx=${stat.count}"
												aria-label="Remove" style="scale: 0.8;" data-prefix="referer">
											</button>
											<input type="hidden" name="refererIds" th:value="${approveMember.employee.employeeNo}"> <input type="hidden" name="refererSteps" th:value="-1">
										</span>
									</div> -->		
									<span th:each="approveMember, stat : ${approvalLineList}" th:if="${approveMember.approval_line_step == -1}" class="badge border text-dark d-flex justify-content-end align-items-center" style="background-color: rgb(248, 249, 250);">
										<span th:text="${approveMember.employee.employeeName}"></span>
										<button type="button" class="btn-close" aria-label="Remove" data-prefix="referer" style="scale: 0.8;"></button>
										<input type="hidden" name="approverIds" th:value="${approveMember.employee.employeeNo}">
										<input type="hidden" name="approverSteps" th:value="-1">
									</span>										
								</div>
							</div>
						</div>
						
						<!-- 추가 버튼 -->
						<div class="gap-2 mb-3 ms-right-2 d-flex justify-content-end" id="approveLineModalDiv">
							<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectApproveLineModal" data-target-div="approveLine1" data-target-prefix="approver">결재자 선택</button>
							<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectApproveLineModal" data-target-div="approveLine2" data-target-prefix="agreer">합의자 선택</button>
							<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectApproveLineModal" data-target-div="approveLine3" data-target-prefix="referer">참조자 선택</button>
						</div>

					</div>


				</div>

				<!-- 결재 내용1(정보) -->
				<div class="mb-3">
					<label class="form-label" for="basic-form-title">제목</label>
					<input th:if="${mode == 'create'}" class="form-control" id="basic-form-title" type="text" placeholder="제목">
					<input th:if="${mode == 'edit'}" th:value="${approval.approval_title}" class="form-control" id="basic-form-title" type="text" placeholder="제목">
					
					<label class="form-label" for="basic-select-format">양식 선택</label>
					<!-- create의 경우 + edit의 경우 select -->
					<select class="form-select" id="basic-select-format" aria-label="Default select example">
					  <option th:if="${mode == 'create'}" value="0" selected disabled>양식을 선택해주세요.</option>
					  <option th:each="formList : ${approvalFormatList}"
					          th:value="${formList.approval_format_no}"
					          th:text="${formList.approval_format_title}"
					          th:selected="${mode == 'edit' and formList.approval_format_no == approval.approval_format.approvalFormatNo}">
					  </option>
					</select>

				</div>
				
				<!-- 결재 내용2(본문) -->
				<div class="mb-3">
					<label class="form-label" for="basic-form-textarea">결재 작성</label>
					<div th:if="${mode == 'create'}" class="form-control" id="basic-form-edit"></div>
					<div th:if="${mode == 'edit'}" th:utext="${approval.approval_format.approvalFormatContent}" class="form-control" id="basic-form-edit"></div>
				</div>
				<!-- 결재 내용3(기존 첨부파일) -->
				<div class="mb-3" th:if="${mode == 'edit'}">
					<label for="lastFiles" class="form-label">기존 첨부 파일</label>
					<div class="form-control" id="lastFiles">
						<ul style="margin-bottom: 0;" class="ps-3">
							<li th:each="approvalAttachFile : ${driveList}">
								<a th:href="@{'/drive/download/approval/' + ${approvalAttachFile.driveAttachNo}}" th:text="${approvalAttachFile.driveOriName}" class="text-primary text-decoration-underline" onmouseover="this.style.textDecoration='none'" onmouseout="this.style.textDecoration='underline'">첨부된 파일이 없습니다.
								</a>
								<input type="hidden" name="approvalAttachFileIds" th:value="${approvalAttachFile.driveAttachNo}">
								<!-- 삭제 뱃지 넣을 곳 -->
							    <span class="badge bg-danger ms-1" style="cursor: pointer;" onclick="removeFile(this)">
							      X
							    </span>
								<!-- 삭제 뱃지 넣을 곳 -->
							</li>
							<li th:if="${#lists.isEmpty(driveList)}" class="text-muted">기존 첨부 파일이 없습니다.</li>
						</ul>
					</div>
				</div>
				<!-- 결재 내용3(파일 업로드) -->
				<div class="mb-3">
					<label class="form-label">파일 업로드</label> <input id="approvalAttachFiles" class="form-control" type="file" multiple>
				</div>
				<div class="d-flex justify-content-end">
					<button type="button" class="btn btn-light" onclick="history.back()">취소</button>
					<button id="approvalSubmitBtn" class="btn btn-primary ms-2" type="button">등록</button>
				</div>
			</form>
			
			
		</div>
		</div>
		
		<!-- 결재자 생성 모달 -->
      
      
      <!-- 트리구조시작 -->
<div class="modal fade" id="selectApproveLineModal" tabindex="-1" aria-hidden="true" aria-labelledby="selectApproveLineModalLabel" data-bs-focus="false">
  <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width: 550px; height: 400px;">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="treeModalLabel">조직도 선택</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>

      <div class="modal-body px-4" style="height: 400px; overflow-y: auto;">
<div class="row" style="height: 100%;">
<div class="col-6">
<ul class="treeview" id="treeviewTree">
  <li class="treeview-list-item">
    <p class="treeview-text">
      <input type="checkbox" class="form-check-input me-2 root-checkbox" data-name="이룸 컴퍼니" data-type="company" data-no="root" onchange="handleCheck(this)">
      <a href="javascript:void(0);"  data-bs-target="#tree-company" >
        <span class="fa-solid fa-folder treeview-icon text-info-light"></span>
        <span id="eroomCompanySpan" class="treeview-label-text fw-bold treeview-label-strong">이룸 컴퍼니</span>
      </a>
    </p>
    <ul class="collapse show treeview-list" id="tree-company">
      <li class="treeview-list-item" th:each="dept : ${departmentList}">
        <p class="treeview-text ms-2">
          <input type="checkbox" class="form-check-input me-2 dept-checkbox" data-type="department" th:attr="data-name=${dept.codeName}, data-no=${dept.separatorCode}" onchange="handleCheck(this)">
          <a href="javascript:void(0);" th:attr="data-bs-toggle='collapse', data-bs-target='#dept-'+${dept.separatorCode}">
            <span class="fa-solid fa-folder treeview-icon"></span>
            <span class="treeview-label-text" th:text="${dept.codeName}">부서명</span>
          </a>
        </p>
        <ul class="collapse treeview-list" th:id="'dept-'+${dept.separatorCode}">
          <li class="treeview-list-item" th:each="team : ${teamMap[dept.codeName]}">
            <p class="treeview-text ms-3">
              <input type="checkbox" class="form-check-input me-2 team-checkbox" data-type="team" th:attr="data-name=${team.codeName}, data-no=${team.separatorCode}" onchange="handleCheck(this)">
              <a href="javascript:void(0);" th:attr="data-bs-toggle='collapse', data-bs-target='#team-'+${team.separatorCode}">
                <span class="fa-solid fa-file-lines treeview-icon"></span>
                <span class="treeview-label-text" th:text="${team.codeName}">팀명</span>
              </a>
            </p>
            <ul class="collapse treeview-list" th:id="'team-'+${team.separatorCode}">
              <li class="treeview-list-item" th:each="emp : ${teamEmployeeMap[team.separatorCode]}">
                <p class="treeview-text ms-4">
                  <input type="checkbox" class="form-check-input me-2 emp-checkbox" data-type="employee" th:attr="data-name=${emp.employee_name}, data-no=${emp.employee_no}" onchange="handleCheck(this)">
                  <span class="fa-solid fa-user treeview-icon"></span>
                  <span class="treeview-label-text" th:text="${emp.employee_name}">사원명</span>
                </p>
              </li>
            </ul>
          </li>
          	<!-- 부서는 있지만 팀 없는 사람 -->
			<li class="treeview-list-item" 
			    th:each="emp : ${teamEmployeeMap[dept.separatorCode + '_notAssigned']}">
			  <p class="treeview-text ms-3"> <!-- ← ms-4 에서 ms-3으로 맞춰줌 -->
			    <input type="checkbox" class="form-check-input me-2 emp-checkbox" data-type="employee"
			           th:attr="data-name=${emp.employee_name}, data-no=${emp.employee_no}"
			           onchange="handleCheck(this)">
			    <span class="fa-solid fa-user treeview-icon"></span>
			    <span class="treeview-label-text" th:text="${emp.employee_name}">사원명</span>
			  </p>
			</li>
        </ul>
      </li>
      <!-- <li class="treeview-list-item">
        <p class="treeview-text ms-2">
          <input type="checkbox" class="form-check-input me-2" data-name="무소속" data-no="noTeam" onchange="handleCheck(this)">
          <a href="javascript:void(0);" data-bs-toggle="collapse" data-bs-target="#noTeam">
            <span class="fa-solid fa-folder treeview-icon"></span>
            <span class="treeview-label-text">무소속</span>
          </a>
        </p>
        <ul class="collapse treeview-list" id="noTeam">
          <li class="treeview-list-item" th:each="emp : ${teamEmployeeMap['noTeam']}">
            <p class="treeview-text ms-4">
              <input type="checkbox" class="form-check-input me-2 emp-checkbox" th:attr="data-name=${emp.employee_name}, data-no=${emp.employee_no}" onchange="handleCheck(this)">
              <span class="fa-solid fa-user treeview-icon"></span>
              <span class="treeview-label-text" th:text="${emp.employee_name}">사원명</span>
            </p>
          </li>
        </ul>
      </li> -->
    </ul>
  </li>
</ul>
</div>

<div class="col-6 d-flex flex-column">
  <!-- [1] 상단 고정 영역 -->
  <div id="selectedResult"
       class="border bg-white rounded p-2 mb-2 small"
       style="position: sticky; top: 0; z-index: 2; background-color: white; ">
    <strong>선택한 항목:</strong>
    <div style="overflow-y: auto; max-height: 270px;" id="selectedTags" class="mt-1 flex-wrap gap-2"></div>
  </div>

  <!-- [2] 중간: 빈 영역 (스크롤 여유) -->
  <div class="flex-grow-1"></div>

  <!-- [3] 하단 고정 영역 -->
  <div class="text-end"
       style="position: sticky; bottom: 0; z-index: 2; background-color: white;">
    <button id="clearBtn" class="btn btn-light btn-sm" type="button">비우기</button>
  </div>
</div>


</div>
      </div>

      <div class="modal-footer py-2">
        <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary btn-sm" onclick="confirmSelection()">선택 완료</button>
      </div>
    </div>
  </div>
</div>
<!-- 트리구조끝 -->
      
      
      
      <!-- 합의자 생성 모달 -->
<div class="modal fade" id="selectApproveLine2Modal" tabindex="-1"
  aria-labelledby="selectApproveLine2ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h3>합의자 추가</h3>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
          aria-label="닫기"></button>
      </div>
      <form id="createApprovalLineForm2">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">소속</label>
            <select class="form-select" id="agreer-departmentSelect">
              <option disabled selected>-- 소속 선택 --</option>
              <option th:each="dept : ${structureList}" 
                th:value="${dept.separator_code}" 
                th:text="${dept.separator_name}" 
                th:selected="${dept.separator_name == param.department}"></option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">참여자 선택</label>
            <div class="d-flex">
              <select id="agreer-employeeSelect" class="form-select me-2" style="flex:1;">
                <option disabled selected>-- 참여자 선택 --</option>
              </select>
              <button type="button" class="btn btn-outline-primary" data-action="addParticipant">추가</button>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">선택된 참여자</label>
            <div id="agreer-selectedParticipants"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">추가</button>
        </div>
        <input type="hidden" name="creater" th:value="${#authentication.principal.employee.employeeNo}">
      </form>
    </div>
  </div>
</div>
      
      
      
      <!-- 참조자 생성 모달 -->
<div class="modal fade" id="selectApproveLine3Modal" tabindex="-1"
  aria-labelledby="selectApproveLine3ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h3>참조자 추가</h3>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
          aria-label="닫기"></button>
      </div>
      <form id="createApprovalLineForm3">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">소속</label>
            <select class="form-select" id="referer-departmentSelect" >
              <option disabled selected>-- 소속 선택 --</option>
              <option th:each="dept : ${structureList}" 
                th:value="${dept.separator_code}" 
                th:text="${dept.separator_name}" 
                th:selected="${dept.separator_name == param.department}"></option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">참여자 선택</label>
            <div class="d-flex">
              <select id="referer-employeeSelect" class="form-select me-2" style="flex:1;">
                <option disabled selected>-- 참여자 선택 --</option>
              </select>
              <button type="button" class="btn btn-outline-primary" data-action="addParticipant">추가</button>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">선택된 참여자</label>
            <div id="referer-selectedParticipants"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">추가</button>
        </div>
        <input type="hidden" name="creater" th:value="${#authentication.principal.employee.employeeNo}">
      </form>
    </div>
  </div>
</div>
      
      
		
		
		
		
	<!-- 결재서 양식 선택시 + 해당 페이지 진입시, fetch로 결재서 양식 내용 가져오기 -->
	<script th:inline="javascript">
	  function loadApprovalFormat() {
	    const select = document.getElementById("basic-select-format");
	    const selectedValue = select.value;
	    const edit_approval_no = /*[[${approval?.approval_no}]]*/ null;
		
	    fetch("/approval/format", {
	      method: 'POST',
	      headers: {
	        'Content-Type': 'application/json',
	        'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content,
	        'header': document.querySelector('meta[name="_csrf_header"]').content
	      },
	      body: JSON.stringify({
	        approval_format_no: selectedValue,
	        edit_approval_no: edit_approval_no
	      })
	    })
	    .then(response => response.json())
	    .then(data => {
	      if (data.res_code == "200") {
	        document.getElementById("basic-form-edit").innerHTML = data.approvalFormatContent;
	        document.getElementById("approvalPageTitle").innerText = data.approvalFormatTitle + ' 결재서 작성';
	
	        const mode = data.mode;
	        const approvalContent = data.approvalContent;
	
/* 	        if (mode === 'edit' && approvalContent) {
	          setTimeout(() => {
	            for (const key in approvalContent) {
	              const inputField = document.querySelector(`#basic-form-edit [name="${key}"]`);
	              if (inputField) {
	                inputField.value = approvalContent[key];
	              }
	            }
	            
	          }, 0); */
	          if (mode === 'edit' && approvalContent) {
	        	  setTimeout(() => {
	        	    for (const key in approvalContent) {
	        	      const inputFields = document.querySelectorAll(`#basic-form-edit [name="${key}"]`);

	        	      inputFields.forEach((inputField) => {
	        	        if (inputField.type === "radio" || inputField.type === "checkbox") {
	        	          
	        	          // 체크박스인 경우 배열로 전달될 수 있으므로 체크해야 함
	        	          if (Array.isArray(approvalContent[key])) {
	        	            if (approvalContent[key].includes(inputField.value)) {
	        	              inputField.checked = true;
	        	            }
	        	          } else {
	        	            // 일반 라디오 버튼처럼 단일 값인 경우
	        	            if (inputField.value === approvalContent[key]) {
	        	              inputField.checked = true;
	        	            }
	        	          }

	        	        } else {
	        	          // 일반 input일 경우
	        	          inputField.value = approvalContent[key];
	        	        }
	        	      });
	        	    }
	        	  }, 0);
	        	}
	        
	        

			const selectedFormValue = document.getElementById("basic-select-format").value;
			if(selectedFormValue == '5') {
				const dateInput = document.querySelector('[name="issuedDate"]');
				if(dateInput){
				const today = new Date().toISOString().split('T')[0];
				dateInput.value = today;
				}
			}
	        
	        
	        
	      } else {
	        // alert("양식 불러오기에 실패했습니다.");
	      }
	    });
	    

	    
	  }
	
	  // 페이지 로드시 + 양식 선택시 각각 실행
	  document.addEventListener('DOMContentLoaded', loadApprovalFormat);
	  document.getElementById("basic-select-format").addEventListener("change", loadApprovalFormat);
	</script>


	
	<!-- 결재자 추가 스크립트 -->
<!-- 트리구조 JS -->
<script>
// 1차 로직
/* let targetDiv = null;
let targetPrefix = null;
document.querySelectorAll('[data-bs-target="#selectApproveLineModal"]').forEach(button => {
  button.addEventListener('click', function() {
	  
    targetDiv = this.dataset.targetDiv; // data-target-div 값 추출
    targetPrefix = this.dataset.targetPrefix; // data-target-prefix 값 추출
    resetTree(); // 모달 진입시 초기화
	
    // 결재자, 합의자, 참조자 각각의 ID 가져오기
    const approverIds = new Set(Array.from(document.querySelectorAll('input[name="approverIds"]')).map(el => el.value));
    const agreerIds = new Set(Array.from(document.querySelectorAll('input[name="agreerIds"]')).map(el => el.value));
    const refererIds = new Set(Array.from(document.querySelectorAll('input[name="refererIds"]')).map(el => el.value));
      
      
    // 모달 진입 시 회사/부서/팀 체크박스 숨김 처리
    const checkboxes = document.querySelectorAll('#treeviewTree input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      const type = checkbox.getAttribute('data-type');
      
      // 결재자, 합의자, 참조자 겹치면 visible hidden
      const id = checkbox.getAttribute('data-no');
      	// 조건 1: 결재자 모달인데 합의자나 참조자에 이미 포함된 경우
      if (targetPrefix === 'approver' && (agreerIds.has(id) || refererIds.has(id))) {
          checkbox.style.visibility = 'hidden';
        } 
        // 조건 2: 합의자 모달인데 결재자나 참조자에 이미 포함된 경우
        else if (targetPrefix === 'agreer' && (approverIds.has(id) || refererIds.has(id))) {
          checkbox.style.visibility = 'hidden';
        } 
        // 조건 3: 참조자 모달인데 결재자나 합의자에 이미 포함된 경우
        else if (targetPrefix === 'referer' && (approverIds.has(id) || agreerIds.has(id))) {
          checkbox.style.visibility = 'hidden';
        } 
        // 조건 4: 결재자나 합의자인 경우 회사/부서/팀은 숨김 처리
        else if ((targetPrefix === 'approver' || targetPrefix === 'agreer') && type !== 'employee') {
          checkbox.style.visibility = 'hidden';
        } 
        else {
          checkbox.style.visibility = 'visible';
        }
    });
    
  });
}); */

// 2차 로직(결재자,합의자 선택시 참조자에서 체크박스 안보이게)
/* let targetDiv = null;
let targetPrefix = null;

document.querySelectorAll('[data-bs-target="#selectApproveLineModal"]').forEach(button => {
  button.addEventListener('click', function() {
    
    targetDiv = this.dataset.targetDiv; // data-target-div 값 추출
    targetPrefix = this.dataset.targetPrefix; // data-target-prefix 값 추출
    resetTree(); // 모달 진입시 초기화

    // 결재자, 합의자, 참조자 각각의 ID 가져오기
    const approverIds = new Set(Array.from(document.querySelectorAll('input[name="approverIds"]')).map(el => el.value));
    const agreerIds = new Set(Array.from(document.querySelectorAll('input[name="agreerIds"]')).map(el => el.value));
    const refererIds = new Set(Array.from(document.querySelectorAll('input[name="refererIds"]')).map(el => el.value));

    // console.log("[디버그] 모달 열릴 때 정보 로딩");
    // console.log("결재자 목록: ", Array.from(approverIds));
    // console.log("합의자 목록: ", Array.from(agreerIds));
    // console.log("참조자 목록: ", Array.from(refererIds));

    // 모달 진입 시 회사/부서/팀 체크박스 숨김 처리
    const checkboxes = document.querySelectorAll('#treeviewTree input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      const type = checkbox.getAttribute('data-type');
      const id = checkbox.getAttribute('data-no');

      // console.log(`[디버그] 체크박스 탐색 중: ${id} (${type})`);

      // 조건 1: 결재자 모달인데 합의자나 참조자에 이미 포함된 경우
      if (targetPrefix === 'approver' && (agreerIds.has(id) || refererIds.has(id))) {
          checkbox.style.visibility = 'hidden';
       // console.log(`[숨김 처리] 결재자 모달 - 이미 합의자 또는 참조자에 있음: ${id}`);
      } 
      // 조건 2: 합의자 모달인데 결재자나 참조자에 이미 포함된 경우
      else if (targetPrefix === 'agreer' && (approverIds.has(id) || refererIds.has(id))) {
          checkbox.style.visibility = 'hidden';
       // console.log(`[숨김 처리] 합의자 모달 - 이미 결재자 또는 참조자에 있음: ${id}`);
      } 
      // 조건 3: 참조자 모달인데 결재자나 합의자에 이미 포함된 경우
      else if (targetPrefix === 'referer' && (approverIds.has(id) || agreerIds.has(id))) {
          checkbox.style.visibility = 'hidden';
       // console.log(`[숨김 처리] 참조자 모달 - 이미 결재자 또는 합의자에 있음: ${id}`);
      } 
      // 조건 4: 결재자나 합의자인 경우 회사/부서/팀은 숨김 처리
      else if ((targetPrefix === 'approver' || targetPrefix === 'agreer') && type !== 'employee') {
          checkbox.style.visibility = 'hidden';
       // console.log(`[숨김 처리] 회사/부서/팀 - 결재자 또는 합의자는 직원만 선택 가능: ${id}`);
      } 
      else {
          checkbox.style.visibility = 'visible';
       // console.log(`[보임 처리] 선택 가능: ${id}`);
      }
    });

    // 상위 조직이 참조자로 들어갔으면 하위 직원 체크박스 숨기기
    // console.log("==== 참조자 트리 디버그 시작 ====");
    refererIds.forEach(refId => {
    	// console.log(`상위 조직 ID: ${refId}`);
      
      const parentNode = document.querySelector(`input[data-no="${refId}"]`);
   // console.log("찾은 상위 조직 노드:", parentNode);

      if (parentNode) {
        const childNodes = parentNode.closest('li').querySelectorAll('input[data-type="employee"]');
     // console.log("찾은 하위 직원들:");
        childNodes.forEach(child => console.log("->", child.getAttribute('data-no')));

        childNodes.forEach(child => {
          child.style.display = 'none';
       // console.log(`숨김 처리된 직원: ${child.getAttribute('data-no')}`);
        });
      }
    });
 // console.log("==== 참조자 트리 디버그 종료 ====");
  });
}); */
// 3차 로직(결재,합의 선택된 경우 참조에서 상위 부서 숨기기)
/* let targetDiv = null;
let targetPrefix = null;

document.querySelectorAll('[data-bs-target="#selectApproveLineModal"]').forEach(button => {
  button.addEventListener('click', function() {
    targetDiv = this.dataset.targetDiv;
    targetPrefix = this.dataset.targetPrefix;
    resetTree(); // 모달 진입시 초기화
    
    // 1. 결재자, 합의자, 참조자 각각의 ID 가져오기
    const approverIds = new Set(Array.from(document.querySelectorAll('input[name="approverIds"]')).map(el => el.value));
    const agreerIds = new Set(Array.from(document.querySelectorAll('input[name="agreerIds"]')).map(el => el.value));
    const refererIds = new Set(Array.from(document.querySelectorAll('input[name="refererIds"]')).map(el => el.value));

    console.log("현재 선택된 결재자 목록:", approverIds);
    console.log("현재 선택된 합의자 목록:", agreerIds);
    console.log("현재 선택된 참조자 목록:", refererIds);

    // 2. 트리의 모든 체크박스 탐색
    const checkboxes = document.querySelectorAll('#treeviewTree input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      const type = checkbox.getAttribute('data-type');
      const id = checkbox.getAttribute('data-no');

      // 조건 1: 결재자 모달인데 합의자나 참조자에 이미 포함된 경우
      if (targetPrefix === 'approver' && (agreerIds.has(id) || refererIds.has(id))) {
        checkbox.style.visibility = 'hidden';
      } 
      // 조건 2: 합의자 모달인데 결재자나 참조자에 이미 포함된 경우
      else if (targetPrefix === 'agreer' && (approverIds.has(id) || refererIds.has(id))) {
        checkbox.style.visibility = 'hidden';
      } 
      // 조건 3: 참조자 모달인데 결재자나 합의자에 이미 포함된 경우
      else if (targetPrefix === 'referer' && (approverIds.has(id) || agreerIds.has(id))) {
        checkbox.style.visibility = 'hidden';
      } 
      // 조건 4: 결재자나 합의자인 경우 회사/부서/팀은 숨김 처리
      else if ((targetPrefix === 'approver' || targetPrefix === 'agreer') && type !== 'employee') {
        checkbox.style.visibility = 'hidden';
      } 
      else {
        checkbox.style.visibility = 'visible';
      }
    });

    // 3. 상위 조직 체크박스 숨기기
    console.log("상위 조직 체크박스 숨기기");

    // 선택된 합의자와 결재자에 대해 상위 조직 숨기기
    [...agreerIds, ...approverIds].forEach(id => {
      console.log(`선택된 직원 ID 탐색: ${id}`);
      const employeeCheckbox = document.querySelector(`input[data-no="${id}"]`);
      if (employeeCheckbox) {
        let parentLi = employeeCheckbox.closest('li.treeview-list-item');
        while (parentLi) {
          const parentCheckbox = parentLi.querySelector(':scope > .treeview-text input[data-type="department"], :scope > .treeview-text input[data-type="team"]');
          
          if (parentCheckbox) {
            console.log(`숨김 처리된 상위 조직: ${parentCheckbox.getAttribute('data-no')}`);
            parentCheckbox.style.visibility = 'hidden';
          }
          
          // 최상위 "이룸 컴퍼니" 체크박스 숨기기
          const companyCheckbox = parentLi.querySelector(':scope > .treeview-text input[data-type="company"]');
          if (companyCheckbox) {
            console.log("최상위 이룸 컴퍼니 숨김 처리");
            companyCheckbox.style.visibility = 'hidden';
          }
          
          parentLi = parentLi.parentElement.closest('li.treeview-list-item');
        }
      }
    });

  });
}); */
// 4차 로직(결재,합의 선택된 경우 참조에서 상위 부서 숨기기 + 상위 부서 참조 넣으면 결재,합의에 직원들 체크박스 안보이게)
let targetDiv = null;
let targetPrefix = null;
document.querySelectorAll('[data-bs-target="#selectApproveLineModal"]').forEach(button => {
	  button.addEventListener('click', function() {
		// console.clear(); // 콘솔 정리
	    // console.log("모달 열림 - Target Prefix:", targetPrefix);
	    targetDiv = this.dataset.targetDiv;
	    targetPrefix = this.dataset.targetPrefix;
	    resetTree();

	    // 결재자, 합의자, 참조자 각각의 ID 가져오기
	    const approverIds = new Set(Array.from(document.querySelectorAll('input[name="approverIds"]')).map(el => el.value));
	    const agreerIds = new Set(Array.from(document.querySelectorAll('input[name="agreerIds"]')).map(el => el.value));
	    const refererIds = new Set(Array.from(document.querySelectorAll('input[name="refererIds"]')).map(el => el.value));

	 	// console.log("Approver IDs:", [...approverIds]);
	    // console.log("Agreer IDs:", [...agreerIds]);
	    // console.log("Referer IDs:", [...refererIds]);

	    // 모달 진입 시 체크박스 숨김 처리
	    const checkboxes = document.querySelectorAll('#treeviewTree input[type="checkbox"]');
	    checkboxes.forEach(checkbox => {
	      const id = checkbox.getAttribute('data-no');
	      const type = checkbox.getAttribute('data-type');

	   // console.log(`🔎 체크박스 탐색 중... ID: ${id}, Type: ${type}`);
	      
	      if (targetPrefix === 'approver' && (agreerIds.has(id) || refererIds.has(id))) {
	    	// console.log(`[HIDE] 결재자 모달 - 숨김 처리된 ID: ${id}`);
	        checkbox.style.visibility = 'hidden';
	      } else if (targetPrefix === 'agreer' && (approverIds.has(id) || refererIds.has(id))) {
	    	// console.log(`[HIDE] 합의자 모달 - 숨김 처리된 ID: ${id}`);
	        checkbox.style.visibility = 'hidden';
	      } else if (targetPrefix === 'referer' && (approverIds.has(id) || agreerIds.has(id))) {
	    	// console.log(`[HIDE] 참조자 모달 - 숨김 처리된 ID: ${id}`);
	        checkbox.style.visibility = 'hidden';
	      } else if ((targetPrefix === 'approver' || targetPrefix === 'agreer') && type !== 'employee') {
	    	// console.log(`[HIDE] 회사/부서/팀 숨김 처리된 ID: ${id}`);
	        checkbox.style.visibility = 'hidden';
	      } else {
	    	// console.log(`[SHOW] 보이는 ID: ${id}`);
	        checkbox.style.visibility = 'visible';
	      }
	    });

	 // 참조자로 선택된 상위 조직의 하위 직원 숨기기
	    if (targetPrefix !== 'referer') {
	      refererIds.forEach(id => {
	        const parentCheckbox = document.querySelector(`input[data-no="${id}"]`);
	     // console.log("참조자로 선택된 조직 탐색 ID:", id);

	        if (parentCheckbox) {
	        	// console.log("참조자로 선택된 조직 발견:", id);
	          const parentNode = parentCheckbox.closest('li.treeview-list-item');

	          if (parentNode) {
	            // 모든 하위 treeview-list-item의 employee 타입 체크박스 탐색 (깊이 탐색으로 수정)
	            const childCheckboxes = parentNode.querySelectorAll('input[data-type="employee"]'); // 더 깊이 탐색
	            // const childCheckboxes = parentNode.querySelectorAll('li.treeview-list-item input[data-type="employee"]');
	         // console.log("하위 직원 탐색 완료:", childCheckboxes);

	            if (childCheckboxes.length > 0) {
	            	// console.log(`하위 직원 ${childCheckboxes.length}명 발견`);
	            } else {
	            	// console.log("하위 직원이 없습니다.");
	            }

	            childCheckboxes.forEach(child => {
	            	// console.log(`[HIDE] 참조자 상위 선택에 따른 하위 숨김: ${child.getAttribute('data-no')}`);
	              child.style.visibility = 'hidden';

	              // 혹시 visibility가 안 먹으면 display로 전환
	              if (child.style.visibility !== 'hidden') {
	                child.style.display = 'none';
	              }
	            });
	          }
	        }
	      });
	    } else{
	    	// else문이 제일 나중에 추가한 곳!!! 오류 생기면 여기부터 의심하기!!!!
	    	const checkBoxTemp = document.querySelector('input[data-no="root"]');
	    	if(checkBoxTemp){
	    		checkBoxTemp.style.visibility = 'hidden';
	    	}
	    }
	    [...agreerIds, ...approverIds].forEach(id => {
	    	// console.log(`선택된 직원 ID 탐색: ${id}`);
	        const employeeCheckbox = document.querySelector(`input[data-no="${id}"]`);
	        if (employeeCheckbox) {
	          let parentLi = employeeCheckbox.closest('li.treeview-list-item');
	          while (parentLi) {
	            const parentCheckbox = parentLi.querySelector(':scope > .treeview-text input[data-type="department"], :scope > .treeview-text input[data-type="team"]');
	            
	            if (parentCheckbox) {
	            	// console.log(`숨김 처리된 상위 조직: ${parentCheckbox.getAttribute('data-no')}`);
	              parentCheckbox.style.visibility = 'hidden';
	            }
	            
	            // 최상위 "이룸 컴퍼니" 체크박스 숨기기
	            const companyCheckbox = parentLi.querySelector(':scope > .treeview-text input[data-type="company"]');
	            if (companyCheckbox) {
	            	// console.log("최상위 이룸 컴퍼니 숨김 처리");
	              companyCheckbox.style.visibility = 'hidden';
	            }
	            
	            parentLi = parentLi.parentElement.closest('li.treeview-list-item');
	          }
	        }
	      });




	  });
	});








function handleCheck(checkbox) {
  const name = checkbox.getAttribute('data-name');
  const code = checkbox.getAttribute('data-no');
  const type = checkbox.getAttribute('data-type');
  const li = checkbox.closest('li.treeview-list-item');

  // 결재자, 합의자인 경우 팀/부서/회사 선택 불가
  if ((targetPrefix === 'approver' || targetPrefix === 'agreer') && type !== 'employee') {
    alert('결재자와 합의자는 사원만 선택 가능합니다.');
    checkbox.checked = false;
    return;
  }

  // 최대 5명 제한 체크
  const selectedCount = document.querySelectorAll('#selectedTags div').length;
  if (selectedCount >= 5 && checkbox.checked && (targetPrefix === 'approver' || targetPrefix === 'agreer')) {
    checkbox.checked = false;
    return;
  }
  
  
  if (checkbox.checked) {
    addTag(name, code);
    handleHighlight(li);
  } else {
    removeTag(code);
  }

  updateChildren(checkbox, checkbox.checked);
  updateParents(checkbox);
}

function updateChildren(checkbox, isChecked) {
	  const li = checkbox.closest('li.treeview-list-item');
	  if (!li) return;

	  const descendants = li.querySelectorAll('input[type="checkbox"]');
	  descendants.forEach(child => {
	    if (child !== checkbox) {
	      child.checked = isChecked;

	      // 하위 태그 제거 (상위 클릭 시 기존 하위 태그 남는 문제 해결)
	      const code = child.getAttribute('data-no');
	      removeTag(code);
	    }
	  });
	}


function updateParents(checkbox) {
	  let li = checkbox.closest('li.treeview-list-item');

	  while (li) {
	    const parentLi = li.parentElement.closest('li.treeview-list-item');
	    if (!parentLi) break;

	    const parentCheckbox = parentLi.querySelector(':scope > .treeview-text input[type="checkbox"]');
	    const childCheckboxes = Array.from(parentLi.querySelectorAll(':scope > ul > li.treeview-list-item > .treeview-text input[type="checkbox"]'));

	    const allChecked = childCheckboxes.length > 0 && childCheckboxes.every(cb => cb.checked);
	    const someChecked = childCheckboxes.some(cb => cb.checked);

	    if (parentCheckbox) {
	      if (allChecked && (targetPrefix === 'referer')) {
			// 하위 체크된 노드들 중 'employee'만 필터링
			const employeeNodes = childCheckboxes.filter(cb => cb.getAttribute('data-type') === 'employee');
			
			// 팀원 수가 5명 이하이면 상위 체크를 막는다.
			/* if (employeeNodes.length <= 5 && ((targetPrefix === 'approver' || targetPrefix === 'agreer') && type !== 'employee')) {
			  parentCheckbox.checked = false;
			  return;
			} */
			
			// 팀원 수가 5명 초과일 때만 상위 체크
			parentCheckbox.checked = true;

	        // 상위만 tag
	        const pname = parentCheckbox.getAttribute('data-name');
	        const pcode = parentCheckbox.getAttribute('data-no');
	        addTag(pname, pcode);

	        // 하위 tag 제거
	        childCheckboxes.forEach(cb => removeTag(cb.getAttribute('data-no')));

	      } else if (someChecked) {
	        parentCheckbox.checked = false;

	        // 상위 tag 제거
	        const pcode = parentCheckbox.getAttribute('data-no');
	        removeTag(pcode);

	        // 하위 중 체크된 것만 tag 추가
	        childCheckboxes.forEach(cb => {
	          const cname = cb.getAttribute('data-name');
	          const ccode = cb.getAttribute('data-no');
	          if (cb.checked) addTag(cname, ccode);
	          else removeTag(ccode);
	        });

	      } else {
	        parentCheckbox.checked = false;

	        // 전부 제거
	        const pcode = parentCheckbox.getAttribute('data-no');
	        removeTag(pcode);
	      }
	    }

	    li = parentLi;
	  }
	}



/* function addTag(label, code) {
  const tagWrap = document.getElementById("selectedTags");
  if (document.getElementById(`tag-${code}`)) return;

  const tag = document.createElement("span");
  tag.className = "badge bg-primary text-white d-flex align-items-center";
  tag.id = `tag-${code}`;
  tag.name = `tag-${label}`;
  tag.innerHTML = `${label} <button type="button" class="btn-close btn-close-white btn-sm ms-1" onclick="removeTag('${code}', true)"></button>`;
  tagWrap.appendChild(tag);
}

	function removeTag(code, skipCheckbox = false) {
	  const tag = document.getElementById(`tag-${code}`);
	  if (tag) tag.remove();

	  if (!skipCheckbox) return;

	  const checkbox = document.querySelector(`input[type="checkbox"][data-no="${code}"]`);
	  if (checkbox && checkbox.checked) {
	    checkbox.checked = false;
	    handleCheck(checkbox); // 연쇄 동기화
	  }
	} */
	
	function addTag(label, code) {
		  const tagWrap = document.getElementById("selectedTags");
		  if (document.getElementById(`tag-${code}`)) return;

		  // Card 생성
		  const card = document.createElement("div");
		  card.className = "card mb-2"; // 여기서 flex는 제거됨
		  card.id = `tag-${code}`;
		  card.name = `tag-${label}`;
		  card.style.borderRadius = "5px";
		  card.style.padding = "8px";
		  card.style.backgroundColor = "#f8f9fa";
		  card.style.display = "block"; // 한 줄씩 표시

		  // 이름 라벨
		  const labelElement = document.createElement("span");
		  labelElement.textContent = label;
		  card.appendChild(labelElement);

		  // 삭제 버튼
		  const button = document.createElement("button");
		  button.type = "button";
		  button.className = "btn-close";
		  button.style.float = "right"; // 오른쪽 정렬
		  button.setAttribute("aria-label", "Remove");
		  button.addEventListener("click", () => {
		    card.remove();
		    removeTag(code, true);  // 태그 삭제 시 체크박스도 해제
		  });

		  card.appendChild(button);

		  // Card를 선택된 태그 컨테이너에 추가
		  tagWrap.appendChild(card);
		}

	
	function removeTag(code, skipCheckbox = false) {
		  const tag = document.getElementById(`tag-${code}`);
		  if (tag) tag.remove();

		  if (!skipCheckbox) return;

		  const checkbox = document.querySelector(`input[type="checkbox"][data-no="${code}"]`);
		  if (checkbox && checkbox.checked) {
		    checkbox.checked = false;
		    handleCheck(checkbox); // 연쇄 동기화
		  }
		}




function confirmSelection() {
  const selected = document.querySelectorAll("#selectedTags .card");
  // 이미 존재하는 뱃지 및 히든 인풋 초기화
  const targetContainer = document.getElementById(targetDiv);
  targetContainer.innerHTML = "";
  const element1 = document.getElementById("approvelLineTemp1");
  const element2 = document.getElementById("approvelLineTemp2");
  const element3 = document.getElementById("approvelLineTemp3");
	if (selected.length !== 0) {
	  if (targetPrefix === 'approver' && element1) {
	    element1.style.display = 'none';
	  } else if (targetPrefix === 'agreer' && element2) {
	    element2.style.display = 'none';
	  } else if (targetPrefix === 'referer' && element3) {
	    element3.style.display = 'none';
	  }
	} else{
	  if (targetPrefix === 'approver' && element1) {
	    element1.style.display = 'block';
	  } else if (targetPrefix === 'agreer' && element2) {
	    element2.style.display = 'block';
	  } else if (targetPrefix === 'referer' && element3) {
	    element3.style.display = 'block';
	  }
	}
  
  const resultCodeAndNum = Array.from(selected).map(el => el.id.replace('tag-', ''));
  const resultName = Array.from(selected).map(el => el.name.replace('tag-', ''));
  const result = Array.from(selected).map((el, index) => ({
	    code: el.id.replace('tag-', ''),
	    name: el.name.replace('tag-', ''),
	    step: index + 1 // 순서를 추가
  }));
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 부서, 팀은 separatorCode 그리고 사원은 employeeNo가 result에 담깁니다~
  // JSON으로 보내고 Controller에서는 @ResponseBody + 매개변수에는 @RequestBody List<String> 사용해서 받아서 쓰시면 됩니다. 
  console.log("확정된 선택 바구니:", result);
//반복문을 통해 뱃지 및 히든 인풋 생성
	result.forEach(({ code, name, step }) => {
	  // 뱃지 생성
	  const badge = document.createElement("span");
	  badge.className = 'badge border text-dark d-flex justify-content-end align-items-center';
	  badge.style.backgroundColor = "#f8f9fa";
	
	  // 텍스트 영역 생성
	  const nameSpan = document.createElement("span");
	  nameSpan.textContent = name;
	
	  // 닫기 버튼 생성
	  const button = document.createElement("button");
	  button.type = "button";
	  button.className = "btn-close";
	  button.setAttribute("aria-label", "Remove");
	  button.setAttribute("data-prefix", targetPrefix);
	  button.style.scale = "0.8";
	
	  // 닫기 이벤트 설정
	  button.addEventListener("click", () => {
	    badge.remove();
	    // 관련된 hidden input도 함께 제거
	    badge.querySelectorAll("input").forEach(input => input.remove());
	  });
	
	  // Hidden input - ID
	  const hiddenId = document.createElement("input");
	  hiddenId.type = "hidden";
	  hiddenId.name = targetPrefix + "Ids";
	  hiddenId.value = code;
	
	  // Hidden input - Step
	  const hiddenStep = document.createElement("input");
	  hiddenStep.type = "hidden";
	  hiddenStep.name = targetPrefix + "Steps";
	  hiddenStep.value = step;
	
	  // 요소 추가
	  badge.appendChild(nameSpan);    // 이름
	  badge.appendChild(button);      // 닫기 버튼
	  badge.appendChild(hiddenId);    // 숨겨진 ID
	  badge.appendChild(hiddenStep);  // 숨겨진 Step
	
	  // 최종 추가
	  targetContainer.appendChild(badge);
	});
	console.log(result);
  // 부서, 팀은 separatorCode 그리고 사원은 employeeNo가 result에 담깁니다~
  // JSON으로 보내고 Controller에서는 @ResponseBody + 매개변수에는 @RequestBody List<String> 사용해서 받아서 쓰시면 됩니다. 
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  // 여기서 result 데이터 가지고 쓰시면 됩니다
  bootstrap.Modal.getInstance(document.getElementById('selectApproveLineModal')).hide();
  targetDiv = null;
  targetPrefix = null;
}

document.addEventListener('DOMContentLoaded', function () {
	  const tree = document.querySelector('#treeviewTree');

	  tree.addEventListener('click', function (e) {
	    // 최상위 `li`인지 확인
	    const clickedLi = e.target.closest('li.treeview-list-item');
	    if (!clickedLi) return;

	    // 클릭된 대상이 '이룸 컴퍼니'인지 확인
	    const isRootCompany = clickedLi.querySelector('#eroomCompanySpan');
	    if (isRootCompany) {
	      e.stopPropagation(); // 🚫 이벤트 전파 방지
	      return;
	    }

	    // 클릭된 요소가 체크박스인지 확인
	    if (e.target.type === 'checkbox') {
	      handleCheck(e.target);
	      e.stopPropagation(); // 🚫 이벤트 전파 방지
	      return;
	    }

	    // 클릭된 요소가 '사원명' 또는 'treeview-text'일 경우만 체크박스 토글
	    if (e.target.classList.contains('treeview-label-text') || e.target.classList.contains('treeview-text')) {
	      const checkbox = clickedLi.querySelector('input[type="checkbox"].emp-checkbox');

	      // 숨겨진 체크박스일 경우 포인터 이벤트 차단
	      if (checkbox && checkbox.offsetParent === null) {
	        e.stopPropagation();
	        return;
	      }

	      if (checkbox) {
	        checkbox.checked = !checkbox.checked; // 체크박스 상태 변경
	        handleCheck(checkbox); // 상하위 동기화 처리
	      }
	    }

	    // 클릭된 요소에 대해 강조 표시 처리 (handleHighlight 재사용)
	    handleHighlight(clickedLi);
	  });
	});




	// 뱃지 x 눌러서 삭제시 처리 방법
	function removeBadgeAndCheck(targetPrefix) {
	  const lineMap = {
	    'approver': document.getElementById("approvelLineTemp1"),
	    'agreer': document.getElementById("approvelLineTemp2"),
	    'referer': document.getElementById("approvelLineTemp3")
	  };
	
	  const targetDiv = document.getElementById(`approveLine${targetPrefix === 'approver' ? 1 : targetPrefix === 'agreer' ? 2 : 3}`);
	  // 남은 뱃지 개수 확인
	  const remainingBadges = targetDiv.querySelectorAll('.badge').length;
		console.log(remainingBadges);
	  // 만약 0개라면 임시 표시를 다시 보여줌
	  if (remainingBadges === 0) {
	    lineMap[targetPrefix].style.display = 'block';
	  }
	}
	
	// 뱃지 x 눌러서 삭제시 처리하는 이벤트
	document.addEventListener('click', (event) => {
	  if (event.target.classList.contains('btn-close')) {
	    const badge = event.target.closest('.badge');
	    const targetPrefix = event.target.getAttribute('data-prefix');
	    
	    if (badge) {
	      badge.remove();  // ✅ 화면에서 뱃지 삭제
	    }

	    if (targetPrefix) {
	      removeBadgeAndCheck(targetPrefix);  // ✅ 남은 개수 확인
	    }
	  }
	});
	
	
</script>

<!-- 비우기 버튼 -->
<script>
	document.getElementById('clearBtn').addEventListener('click', resetTree);
	
	function resetTree() {
		  // 1. 선택된 태그 비우기
		  document.getElementById('selectedTags').innerHTML = '';

		  // 2. 모든 체크박스 해제
		  const checkboxes = document.querySelectorAll('#treeviewTree input[type="checkbox"]');
		  checkboxes.forEach(cb => {
		    cb.checked = false;
		  });

		  // 3. 강조 스타일 제거 (이룸 컴퍼니 제외)
		  document.querySelectorAll('.treeview-icon.text-info-light').forEach(el => {
		    // 이룸 컴퍼니 제외
		    if (!el.closest('a')?.querySelector('#eroomCompanySpan')) {
		      el.classList.remove('text-info-light');
		    }
		  });

		  document.querySelectorAll('.treeview-label-text.treeview-label-strong').forEach(el => {
		    if (el.id !== 'eroomCompanySpan') {
		      el.classList.remove('treeview-label-strong');
		    }
		  });

		  // 4. 트리 접기 (이룸 컴퍼니 제외)
		  document.querySelectorAll('.treeview-list.collapse').forEach(ul => {
		    if (ul.id !== 'tree-company') {
		      ul.classList.remove('show');
		    } else {
		      ul.classList.add('show');
		    }
		  });
		}


</script>

<!-- 색상 강조 -->
<script>
function handleHighlight(li) {
	  if (!li) return; // ❗예외 처리

	  // 기존 강조 제거
	  document.querySelectorAll('.treeview-icon.text-info-light').forEach(el => el.classList.remove('text-info-light'));
	  document.querySelectorAll('.treeview-label-text.treeview-label-strong').forEach(el => el.classList.remove('treeview-label-strong'));

	  // 현재 강조
	  const icon = li.querySelector('.treeview-icon');
	  const label = li.querySelector('.treeview-label-text');
	  if (icon) icon.classList.add('text-info-light');
	  if (label) label.classList.add('treeview-label-strong');

	  // 상위 강조
	  let currentUl = li.parentElement;
	  while (currentUl && currentUl.classList.contains('treeview-list')) {
	    const parentLi = currentUl.closest('li.treeview-list-item');
	    if (!parentLi) break;

	    const parentIcon = parentLi.querySelector('.treeview-icon');
	    const parentLabel = parentLi.querySelector('.treeview-label-text');
	    if (parentIcon) parentIcon.classList.add('text-info-light');
	    if (parentLabel) parentLabel.classList.add('treeview-label-strong');

	    currentUl = parentLi.parentElement;
	  }
	}

</script>
	<script th:inline="javascript">
		document.getElementById('approvalSubmitBtn').addEventListener('click', function (event) {
		  event.preventDefault(); // 기본 제출 방지
		
		  // [1] 제목 & 양식 유효성 검사
		  const approvalTitle = document.getElementById("basic-form-title")?.value?.trim();
		  const formatSelect = document.getElementById("basic-select-format");
		  const approvalFormatNo = formatSelect?.value;
		  let isValid = true;
		  const approvalAttachFiles = document.getElementById("approvalAttachFiles");
		
		  if (!approvalTitle) {
		    document.getElementById("basic-form-title").style.border = "1px solid red";
		    isValid = false;
		  } else {
		    document.getElementById("basic-form-title").style.border = "";
		  }
		
		  if (!approvalFormatNo || formatSelect.value == 0) {
		    formatSelect.style.border = "1px solid red";
		    isValid = false;
		  } else {
		    formatSelect.style.border = "";
		  }
		
		  if (!isValid) {
		    alert("제목과 양식을 모두 입력해주세요.");
		    return;
		  }
		
		  // [2] 양식 입력 필드 유효성 검사 및 데이터 수집
		  const inputElements = document.querySelectorAll("#basic-form-edit [name]");
		  const approvalContent = {};
		  let hasEmpty = false;
		
		  // 체크박스 데이터 임시 저장
		  const checkboxGroups = {};
		  
		  inputElements.forEach(el => {
		    const name = el.name?.trim();
		    const value = el.value?.trim();
		
		    if (!name) return;

		    if (el.type === "radio") {
		      // [라디오 버튼 체크 여부 확인]
		      if (el.checked) {
		        approvalContent[name] = el.value;
		      }
		    } else if (el.type === "checkbox") {
		      // [체크박스 처리 로직]
		      if (!checkboxGroups[name]) {
		        checkboxGroups[name] = [];
		      }
		      if (el.checked) {
		        checkboxGroups[name].push(value);
		      }
		    } else {
		      // [일반 input 처리]
		      if (!value) {
		        hasEmpty = true;
		        el.classList.add("is-invalid");
		        el.style.border = "1px solid red";
		      } else {
		        el.classList.remove("is-invalid");
		        el.style.border = "";
		        approvalContent[name] = value;
		      }
		    }
		  });

		  // 체크박스 그룹을 최종적으로 approvalContent에 추가
		  Object.keys(checkboxGroups).forEach(key => {
		    if (checkboxGroups[key].length > 0) {
		      approvalContent[key] = checkboxGroups[key];
		    }
		  });

		  if (hasEmpty) {
		    alert("결재서 내용을 모두 입력해주세요.");
		    return;
		  }
		
		  // [3] 결재선 유효성 검사
		  const approverIds = Array.from(document.querySelectorAll('input[name="approverIds"]')).map(el => el.value);
		  const approverSteps = Array.from(document.querySelectorAll('input[name="approverSteps"]')).map(el => parseInt(el.value));
		  const agreerIds = Array.from(document.querySelectorAll('input[name="agreerIds"]')).map(el => el.value);
		  const agreerSteps = Array.from(document.querySelectorAll('input[name="agreerSteps"]')).map(el => parseInt(el.value));
		  const refererIds = Array.from(document.querySelectorAll('input[name="refererIds"]')).map(el => el.value);
		  const refererSteps = Array.from(document.querySelectorAll('input[name="refererSteps"]')).map(el => parseInt(el.value));
		  
		
//		  if (approverSteps.length === 0 && agreerSteps.length === 0 && refererSteps.length === 0) {
		  if (approverSteps.length === 0 && agreerSteps.length === 0) {
		    alert("결재자, 합의자를 한 명 이상 선택해주세요.");
		    return;
		  }
		  if (approverSteps.length > 5 || agreerSteps.length > 5) {

			  alert("결재자, 합의자는 각각 최대 5명까지 선택 가능합니다.");
		    return;
		  }
		
		  if (
		    approverIds.length !== approverSteps.length ||
		    agreerIds.length !== agreerSteps.length ||
		    refererIds.length !== refererSteps.length
		  ) {
		    alert("결재자 정보가 올바르지 않습니다. 다시 선택해주세요.");
		    return;
		  }
		
		  // [4] 작성자 정보 수집
		  const writerFields = ["date", "department_name", "team_name", "employee_position", "employee_name"];
		  const writerData = {};
		  let editApprovalNo = null;
		  // edit모드일 경우 approval 객체에서 값 가져오기
			if(/*[[${mode}]]*/ null == 'edit') {
				editApprovalNo = /*[[${approval.approval_no}]]*/ null;
			}
		  
		  writerFields.forEach(field => {
		    const el = document.getElementById(`basic-form-${field}`);
		    writerData[field] = el ? (el.value ?? el.textContent.trim()) : null;
		  });
		  
		
		  // [5-1] 서버 전송
		  /* fetch('/approval/create', {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json',
		      'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content,
		      'header': document.querySelector('meta[name="_csrf_header"]').content
		    },
		    body: JSON.stringify({
		      writer: writerData,
		      title: approvalTitle,
		      format_no: approvalFormatNo,
		      content: approvalContent,
		      approverIds,
		      approverSteps,
		      agreerIds,
		      agreerSteps,
		      refererIds,
		      refererSteps,
		      approvalAttachFiles,
		      editApprovalNo : editApprovalNo
		    })
		  })
		  .then(res => res.json())
		  .then(data => {
		    if (data.res_code === "200") {
		      alert("결재서가 성공적으로 제출되었습니다.");
		      location.href = '/approval/myRequestedApprovals';
		    } else {
		      alert("결재서 제출에 실패했습니다: " + data.res_msg);
		    }
		  })
		  .catch(err => {
		    console.error(err);
		    alert("요청 중 오류가 발생했습니다.");
		  }); */
		  
		  
		  

		  // [5-2] 파일 기능 추가를 위한 formData 추가 버전
		  const fileFormData = new FormData();
		  // 기본 데이터
		  fileFormData.append("title", approvalTitle);
		  fileFormData.append("format_no", approvalFormatNo);
		  fileFormData.append("editApprovalNo", editApprovalNo ?? '');

		  // 작성자 정보
		  fileFormData.append("writer", new Blob([JSON.stringify(writerData)], { type: "application/json" }));

		  // 본문 내용
		  fileFormData.append("content", new Blob([JSON.stringify(approvalContent)], { type: "application/json" }));

		  // 결재선 정보
		  fileFormData.append("approverIds", new Blob([JSON.stringify(approverIds)], { type: "application/json" }));
		  fileFormData.append("approverSteps", new Blob([JSON.stringify(approverSteps)], { type: "application/json" }));
		  fileFormData.append("agreerIds", new Blob([JSON.stringify(agreerIds)], { type: "application/json" }));
		  fileFormData.append("agreerSteps", new Blob([JSON.stringify(agreerSteps)], { type: "application/json" }));
		  fileFormData.append("refererIds", new Blob([JSON.stringify(refererIds)], { type: "application/json" }));
		  fileFormData.append("refererSteps", new Blob([JSON.stringify(refererSteps)], { type: "application/json" }));

		  // 기존 첨부파일 추가
		  const approvalAttachFileIds = Array.from(document.querySelectorAll('input[name="approvalAttachFileIds"]')).map(el => parseInt(el.value));
		  fileFormData.append("approvalAttachFileIds", new Blob([JSON.stringify(approvalAttachFileIds)], { type: "application/json" }));
		  // 새 첨부파일 추가
		  for (const file of approvalAttachFiles.files) {
			  fileFormData.append("files", file); // name="files"가 DTO랑 맞아야 해
		  }

		  // [3] 서버 전송
		  fetch('/approval/create', {
		    method: 'POST',
		    headers: {
		      'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content,
		      'header': document.querySelector('meta[name="_csrf_header"]').content
		    },
		    body: fileFormData
		  })
		  .then(res => res.json())
		  .then(data => {
		    if (data.res_code === "200") {
		      alert("결재서가 성공적으로 제출되었습니다.");
		      location.href = '/approval/myRequestedApprovals';
		    } else {
		      alert("결재서 제출에 실패했습니다: " + data.res_msg);
		    }
		  })
		  .catch(err => {
		    console.error(err);
		    alert("요청 중 오류가 발생했습니다.");
		  });
		  
		  
		  
		  
		  
		  
		  
		  
		});
	</script>
	
    <!-- edit모드로 들어왔을 때 결재자 삭제 스크립트 -->	
	<!-- <script>
	  document.addEventListener("DOMContentLoaded", function () {
	    const closeButtons = document.querySelectorAll(".btn-close");
	
	    closeButtons.forEach(btn => {
	      btn.addEventListener("click", function () {
	        const target = btn.closest("div");
	        target.remove();
	      });
	    });
	  });
	</script> -->
	<!-- 기존 파일 삭제 뱃지 -->
	
	<script>
	function removeFile(element) {
	  const li = element.closest('li');
	  if (li) {
	    li.remove();
	  }
	}
	</script>



	</main>
</body>
</html>